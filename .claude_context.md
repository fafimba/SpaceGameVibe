# .claude_context.md - Referencia TÃ©cnica del Proyecto

> **PropÃ³sito**: Este archivo sirve como mapa de navegaciÃ³n rÃ¡pida del cÃ³digo para Claude Code.
> Contiene ubicaciones exactas, estructuras de datos y puntos de entrada clave.

## âš ï¸ REGLA IMPORTANTE

**ğŸ”„ SIEMPRE ACTUALIZAR ESTE ARCHIVO CUANDO SE MODIFIQUE EL CÃ“DIGO**

Cada vez que Claude Code (o cualquier desarrollador) haga cambios en [index.html](index.html), DEBE actualizar este archivo para reflejar:
- âœ… Nuevas funciones aÃ±adidas (con nÃºmeros de lÃ­nea)
- âœ… Rangos de lÃ­neas que cambiaron
- âœ… Nuevas constantes o variables globales
- âœ… Cambios en estructuras de datos
- âœ… Nuevos sistemas o features
- âœ… Skills aÃ±adidas al Ã¡rbol de habilidades
- âœ… Nuevos tipos de enemigos o mecÃ¡nicas

**Sin este archivo actualizado, Claude perderÃ¡ contexto en futuras conversaciones.**

---

## ğŸ“ Estructura del Proyecto

```
SpaceGameVibe/
â”œâ”€â”€ index.html (~3,900 lÃ­neas) - ÃšNICO ARCHIVO, contiene todo (HTML + CSS + JS)
â””â”€â”€ .claude_context.md (este archivo)
```

## âš¡ OPTIMIZACIONES DE PERFORMANCE (NUEVO - 2026)

El juego ha sido optimizado con 4 sistemas crÃ­ticos para manejar 10x mÃ¡s entidades:

1. **Spatial Partitioning** (Grid Hash 250px) - Reduce colisiones de O(nÂ²) a O(n log n)
2. **Object Pooling** - Elimina garbage collection (42+ alloc/seg â†’ 0)
3. **Culling Mejorado** - Skip rendering de entidades lejanas
4. **Render Batching** - Agrupa draw calls por tipo (200+ â†’ 50)

**Resultado**: 60 FPS constante con 150-200+ enemigos (antes: 15-30 FPS con 50 enemigos)

## ğŸ—ºï¸ Mapa de CÃ³digo (index.html)

### Secciones por LÃ­neas

| LÃ­neas | SecciÃ³n | Contenido |
|--------|---------|-----------|
| 1-147 | HTML + CSS | Estructura DOM, estilos UI, controles tÃ¡ctiles |
| 148-222 | Constantes de ConfiguraciÃ³n | Todos los valores de balanceo del juego |
| 223-390 | Skill Tree Definitions | Ãrbol completo de habilidades (objeto `SKILL_TREE`) |
| 391-509 | Variables Globales de Estado | `gameState`, `input`, `joystick`, etc. |
| **510-780** | **ğŸ†• Sistemas de OptimizaciÃ³n** | **Spatial Grid, Object Pools, Performance Monitor** |
| 781-870 | Setup e InicializaciÃ³n | `init()`, `resetGame()`, `setupInput()`, etc. |
| 871-930 | Input Handling | Teclado, mouse, controles tÃ¡ctiles |
| 1038-1072 | Coordinate System | `worldToScreen()`, **`shouldRenderEntity()`** |
| 1165-1260 | Game Loop Principal | `gameLoop()`, `update()` con spatial grid rebuild |
| 1261-1370 | Sistema de Jugador | Movimiento, disparo, colisiones |
| 1413-1560 | Sistema de Armas | `fireBullet()` con object pooling |
| 1561-1650 | Sistema de Balas | Update con spatial grid para homing |
| 1651-1740 | Sistema de Spawning | Oleadas y generaciÃ³n de enemigos con pools |
| 1741-1890 | Sistema de Enemigos | IA con spatial grid para separaciÃ³n |
| 1891-1940 | Kill & Drops | Eliminar enemigos, pools, generar XP/pickups |
| 1941-2020 | Sistema de Pickups | Con object pooling |
| 2021-2110 | Sistema de XP y Niveles | Con object pooling |
| 2295-2432 | Collision Detection | **Optimizado con spatial grid** |
| 2532-2620 | Particles & Effects | Con object pooling y lÃ­mites dinÃ¡micos |
| 2703-2770 | Render Master | `render()` con debug overlay |
| 2905-3230 | **Funciones de Render** | **Con batching y culling optimizado** |
| 3231-3900 | Game Over, UI, Utils | Pantallas finales, skill tree UI |

## ğŸ¯ Funciones CrÃ­ticas (Quick Reference)

### Core Game Loop (ACTUALIZADO)
```javascript
// LÃ­nea ~1165
gameLoop(timestamp) â†’ requestAnimationFrame
  â†“
// LÃ­nea ~1203
update() â†’ Actualiza toda la lÃ³gica
  â†“ NUEVO: Rebuild spatial grid cada frame (lÃ­nea ~1208)
  spatialGrid.clear()
  for (enemies) spatialGrid.insert(e)
  perfMonitor.update(deltaTime)
  â†“ llama a:
  - updateInput()         // ~930
  - updatePlayer()        // ~1261
  - updateCamera()        // ~1145
  - updateBullets()       // ~1561 (con spatial grid)
  - updateSpawnSystem()   // ~1651
  - updateEnemies()       // ~1741 (con spatial grid)
  - updateEnemyBullets()  // ~1868
  - updatePickups()       // ~1954
  - updateXPOrbs()        // ~2038
  - updateParticles()     // ~2580 (lÃ­mites dinÃ¡micos)
  - checkCollisions()     // ~2295 (optimizado con grid)
```

### ğŸ†• Sistemas de OptimizaciÃ³n (LÃ­neas 510-780)

```javascript
// Spatial Grid (lÃ­nea ~519)
spatialGrid.clear()           // Limpia grid cada frame
spatialGrid.insert(entity, r) // Inserta en celdas 250px
spatialGrid.queryRadius(x,y,r)// Query entidades cercanas

// Object Pools (lÃ­nea ~576)
pools.bullet.acquire()        // Obtiene de pool (no GC)
pools.bullet.release(obj)     // Devuelve a pool
pools.bullet.releaseAll(arr)  // Limpia array completo

// Performance Monitor (lÃ­nea ~695)
perfMonitor.update(dt)        // Actualiza stats
perfMonitor.renderDebug()     // Dibuja overlay (tecla B)

// Culling Helper (lÃ­nea ~1056)
shouldRenderEntity(entity, maxDist) // true si < distancia
```

### Sistema de Armas (ACTUALIZADO con Pooling)
```javascript
fireBullet()          // ~1413 - Dispara con pools.bullet.acquire()
getWeaponStats()      // ~1370 - Calcula stats basado en skills
hasEnemyInAimCone()   // ~1398 - Auto-aim detection
spawnThrusterParticle() // ~1524 - Con pooling
spawnDashParticles()  // ~1545 - Con pooling
```

### Sistema de ProgresiÃ³n
```javascript
collectXP(amount)     // ~1626 - Suma XP, chequea level up
levelUp(levels)       // ~1644 - Aumenta nivel, abre skill tree
openSkillTree()       // ~1700 - Pausa y muestra UI de skills
unlockSkill(skillId)  // ~1800 - Desbloquea skill si cumple prereqs
```

### Spawning & Oleadas (ACTUALIZADO con Pooling)
```javascript
updateSpawnSystem()   // ~1651 - Gestiona oleadas y timers
spawnEnemy()          // ~1718 - Crea enemigo con pools.enemy.acquire()
killEnemy(enemy, i)   // ~1891 - Destruye con pools.enemy.release()
spawnXPOrb(x,y,val)   // ~2022 - Con pools.xpOrb.acquire()
spawnPickup(x,y)      // ~1943 - Con pools.pickup.acquire()
```

## ğŸ“Š Estructuras de Datos Principales

### ğŸ†• Estructuras de OptimizaciÃ³n (Nuevas - LÃ­neas 510-780)

```javascript
// Spatial Grid (lÃ­nea ~519)
spatialGrid = {
  cellSize: 250,              // TamaÃ±o de celda en pixels
  cells: Map<string, Entity[]>, // Map de "x,y" â†’ array de entidades
  getCellKey(x, y),           // Convierte coords a key
  getCellKeysInRadius(x,y,r), // Array de keys en radio
  clear(),                    // Limpia todas las celdas
  insert(entity, radius),     // Inserta en grid
  queryRadius(x,y,r)          // Query entidades cercanas
}

// Object Pools (lÃ­nea ~576)
pools = {
  bullet: ObjectPool(300),      // Pool de 300 balas
  enemy: ObjectPool(150),       // Pool de 150 enemigos
  particle: ObjectPool(600),    // Pool de 600 partÃ­culas
  enemyBullet: ObjectPool(100), // Pool de 100 balas enemigas
  floatingText: ObjectPool(60), // Pool de 60 textos flotantes
  pickup: ObjectPool(20),       // Pool de 20 pickups
  xpOrb: ObjectPool(50)         // Pool de 50 orbs XP
}

// Performance Monitor (lÃ­nea ~695)
perfMonitor = {
  fps: 60,                    // FPS actual
  avgFrameTime: 16,           // Tiempo promedio de frame (ms)
  entityCounts: {...},        // Conteo de cada tipo
  optimizationStats: {
    spatialGridCells: 0,      // Celdas activas en grid
    entitiesCulled: 0         // Entidades no renderizadas
  },
  update(dt),                 // Actualiza stats
  renderDebug()               // Dibuja overlay (tecla B)
}

// Culling Distances (lÃ­nea ~655)
CULLING_DISTANCES = {
  enemies: 6000,      // px desde cÃ¡mara
  particles: 4000,
  pickups: 5000,
  xpOrbs: 5000,
  floatingTexts: 3000,
  bullets: 5760,
  enemyBullets: 5760
}
```

### gameState (Variable Global ~lÃ­nea 403)
```javascript
{
  player: {
    x, y,           // PosiciÃ³n (pixels)
    vx, vy,         // Velocidad (pixels/frame)
    rotation,       // Ãngulo en radianes
    hp,             // Puntos de vida
    maxHP,
    speed,          // Velocidad base
    isDashing,
    dashTimer, dashCooldown,
    invulnerable, invulnerableTimer,
    // Weapon timers
    bulletTimer, rocketTimer, novaTimer
  },

  bullets: [{
    x, y, vx, vy,
    damage,
    piercing,      // true/false
    piercesLeft,   // nÃºmero de penetraciones
    color,
    lifetime
  }],

  enemies: [{
    x, y, vx, vy,
    type,          // 'chaser', 'shooter', 'spinner'
    hp, maxHP,
    damage,
    speed,
    shootTimer,    // para shooters/spinners
    rotation       // para spinners
  }],

  xpOrbs: [{
    x, y, vx, vy,
    value,         // cantidad de XP
    collected,     // boolean
    magnetized     // boolean
  }],

  pickups: [{
    x, y,
    type,          // 'health', 'ammo'
    lifetime
  }],

  // ProgresiÃ³n
  xp: 0,
  level: 1,
  skillPoints: 0,
  unlockedSkills: ['laser_base'],

  // Estado del juego
  wave: 1,
  score: 0,
  kills: 0,
  enemiesInWave: 0,
  maxEnemiesThisWave: 5,
  waveComplete: false,
  waveTimer: 0,
  paused: false,
  gameOver: false,

  // Timers
  spawnTimer: 0,
  spawnInterval: 2000
}
```

### input (Variable Global ~lÃ­nea 430)
```javascript
{
  left, right, up, down,    // booleans
  dash,                     // boolean
  mouse: { x, y },          // posiciÃ³n del cursor
  mouseInCanvas             // boolean
}
```

### SKILL_TREE (Objeto Constante ~lÃ­nea 225)
```javascript
{
  'skill_id': {
    name: 'Display Name',
    description: 'DescripciÃ³n',
    prereqs: ['otro_skill_id'],  // array de IDs prerequisito
    cost: 1,                       // skill points necesarios
    color: '#hex',
    icon: 'tipo'
  }
}
```

## ğŸ” BÃºsquedas RÃ¡pidas por Palabra Clave

### Para encontrar rÃ¡pidamente cÃ³digo relacionado con:

| Buscar | Palabra Clave | UbicaciÃ³n Principal |
|--------|---------------|---------------------|
| **ğŸ†• Spatial Grid** | `spatialGrid` | ~lÃ­nea 519-575 (def), 1208 (uso) |
| **ğŸ†• Object Pooling** | `pools.` | ~lÃ­nea 576-654 (def), en uso en todo el cÃ³digo |
| **ğŸ†• Performance** | `perfMonitor` | ~lÃ­nea 695-780, tecla B para overlay |
| **ğŸ†• Culling** | `shouldRenderEntity` | ~lÃ­nea 1056, usado en renders |
| **ğŸ†• Render Batching** | `byType` | ~lÃ­nea 2905-3230 (renders) |
| DaÃ±o del jugador | `player.hp` | ~lÃ­nea 1261-1370, 2426-2432 |
| Disparo | `fireBullet()` | ~lÃ­nea 1413 (con pooling) |
| Colisiones | `checkCollisions()` | ~lÃ­nea 2295 (optimizado con grid) |
| Enemigos nuevos | `pools.enemy.acquire()` | ~lÃ­nea 1718 (spawnEnemy) |
| XP y nivel | `collectXP`, `levelUp` | ~lÃ­nea 2111, 2124 |
| Skills | `unlockedSkills` | ~lÃ­nea 225-390, 2200+ |
| Canvas render | `ctx.fillRect`, `ctx.arc` | ~lÃ­nea 2703-3230 (con batching) |
| Controles tÃ¡ctiles | `joystick`, `touchControls` | ~lÃ­nea 960-1030 |
| Oleadas | `wave`, `spawnSystem` | ~lÃ­nea 1651-1740 |
| PartÃ­culas | `particles` (pooled) | ~lÃ­nea 2532-2620 (con pools) |

## ğŸ® Tipos de Enemigos (Enemy Types)

### Definidos en `spawnEnemy()` ~lÃ­nea 1261:

1. **'chaser'**
   - HP: 4-10 (escala con oleada)
   - Comportamiento: Persigue al jugador directamente
   - Velocidad: 120-180 px/s

2. **'shooter'**
   - HP: 6-12 (escala con oleada)
   - Comportamiento: Mantiene distancia, dispara proyectiles
   - Cadencia: cada 2 segundos

3. **'spinner'**
   - HP: 8-15 (escala con oleada)
   - Comportamiento: Gira y dispara en patrÃ³n radial (3 balas)
   - Cadencia: cada 3 segundos

## ğŸ› ï¸ Constantes de ConfiguraciÃ³n (~lÃ­nea 148)

### Jugador
```javascript
PLAYER_SPEED = 360           // px/s
PLAYER_HP = 100              // Vida inicial
PLAYER_DASH_MULTIPLIER = 2   // Velocidad del dash
PLAYER_DASH_DURATION = 200   // ms
PLAYER_DASH_COOLDOWN = 3000  // ms
```

### Armas
```javascript
BULLET_SPEED = 800           // px/s
BULLET_DAMAGE_BASE = 2
BULLET_FIRE_RATE_BASE = 200  // ms entre disparos
ROCKET_DAMAGE = 5
ORBITAL_DAMAGE = 3
NOVA_DAMAGE = 4
```

### XP y Niveles
```javascript
XP_PER_LEVEL_BASE = 10       // XP para nivel 2
XP_PER_LEVEL_GROWTH = 1.4    // Multiplicador exponencial
```

## ğŸŒ³ Ãrbol de Habilidades (Skills Map)

### Estructura de Ramas:
```
laser_base (root, unlocked default)
â”œâ”€â”€ laser_dmg1 â†’ laser_dmg2
â”œâ”€â”€ laser_rate1 â†’ laser_rate2
â”œâ”€â”€ spread1 â†’ spread2
â”œâ”€â”€ beam1 (req: laser_dmg1) â†’ beam2
â”œâ”€â”€ orbital1 â†’ orbital2
â”‚            â””â†’ orbital_dmg
â”œâ”€â”€ rockets1 â†’ rockets2
â”‚           â””â†’ rockets_dmg
â”œâ”€â”€ nova1 â†’ nova2
â”œâ”€â”€ hp1 â†’ hp2 â†’ hp3
â”œâ”€â”€ speed1 â†’ speed2
â”œâ”€â”€ dash1
â””â”€â”€ regen1
```

## ğŸ’¡ Puntos de ModificaciÃ³n Comunes

### AÃ±adir nueva arma:
1. Definir en `SKILL_TREE` (~225)
2. AÃ±adir stats en `getWeaponStats()` (~1370)
3. Implementar lÃ³gica en `fireBullet()` (~1413) **usando `pools.bullet.acquire()`**
4. AÃ±adir render si es necesario (~2905+) **con batching**
5. **âš ï¸ Actualizar este archivo (.claude_context.md)**

### AÃ±adir nuevo tipo de enemigo:
1. Crear tipo en `spawnEnemy()` (~1718) **usando `pools.enemy.acquire()`**
2. AÃ±adir comportamiento en `updateEnemies()` (~1741) **considerando spatial grid**
3. Definir patrÃ³n de ataque si aplica
4. **AÃ±adir a render batching** en `renderEnemies()` (~3008+)
5. **âš ï¸ Actualizar este archivo (.claude_context.md)**

### Ajustar dificultad:
1. Modificar constantes (~148-222)
2. Ajustar scaling en `updateSpawnSystem()` (~1651)
3. Cambiar HP/damage de enemigos en `spawnEnemy()` (~1718)
4. **âš ï¸ Actualizar este archivo (.claude_context.md)** si cambiaron constantes

### Cambiar UI:
1. CSS en `<style>` (~7-147)
2. HTML en `<body>` (~1-7)
3. Render functions (~2703-3230)
4. **âš ï¸ Actualizar este archivo (.claude_context.md)** si cambiaron rangos de lÃ­neas

### ğŸ†• Optimizar nueva entidad:
1. **AÃ±adir pool** en `pools` (~576-654) con capacity adecuada
2. **Usar `acquire()`** al crear entidad (no push directo)
3. **Usar `release()`** al destruir entidad (antes de splice)
4. **AÃ±adir a spatial grid** si necesita collision detection rÃ¡pida
5. **Implementar culling** en funciÃ³n de render con `shouldRenderEntity()`
6. **Batch rendering** agrupar por tipo/propiedades visuales
7. **âš ï¸ Actualizar este archivo (.claude_context.md)**

## ğŸ”„ Flujo de EjecuciÃ³n TÃ­pico

```
Usuario abre index.html
  â†“
window.onload â†’ init() (~488)
  â†“
init() llama:
  - resizeCanvas()
  - generateBackground()
  - resetGame()
  - setupInput()
  - setupTouchControls()
  - gameLoop()
  â†“
gameLoop() loop infinito (~772):
  - update() cada frame
  - render all
  â†“
update() (~810):
  - Actualiza input
  - Actualiza jugador (mov, disparo)
  - Actualiza balas (mov, colisiones)
  - Actualiza spawn system (oleadas)
  - Actualiza enemigos (IA, mov)
  - Actualiza XP orbs (magnetismo)
  - Chequea colisiones
  â†“
Si level up â†’ openSkillTree() â†’ PAUSA
Usuario elige skill â†’ unlockSkill() â†’ closeSkillTree() â†’ RESUME
  â†“
Si player.hp <= 0 â†’ showGameOver()
```

## ğŸ“ Notas de Arquitectura

- **Single File Application**: Todo en un HTML (facilita distribuciÃ³n)
- **No Framework**: JavaScript vanilla puro
- **Game Loop Pattern**: RAF + delta time
- **State Machine**: gameState controla todo
- **ğŸ†• Spatial Partitioning**: Grid hash 250px para optimizar colisiones O(n log n)
- **ğŸ†• Object Pooling**: Pre-allocated pools eliminan GC pauses (600 particles, 300 bullets, etc.)
- **ğŸ†• Render Batching**: Agrupa entities por tipo antes de render (200+ â†’ 50 draw calls)
- **ğŸ†• Dynamic Culling**: Skip rendering de entities >4000-6000px de cÃ¡mara
- **ğŸ†• Adaptive Particle Limits**: Reduce particles cuando hay muchas entities (300 â†’ 150)
- **ğŸ†• Performance Monitor**: Debug overlay (tecla B) muestra FPS, entity counts, grid stats
- **Responsive**: Adapta canvas + touch controls en mÃ³vil

## ğŸš¨ Puntos de AtenciÃ³n

1. **âœ… Performance OPTIMIZADA**: Soporta 150-200+ entidades a 60 FPS constante
   - âœ… Spatial Grid reduce colisiones de O(nÂ²) a O(n log n)
   - âœ… Object Pooling elimina GC pauses completamente
   - âœ… Render Batching reduce draw calls en 75%
   - âœ… Culling dinÃ¡mico skip rendering de entities lejanas
   - ğŸ¯ **Mejora total: 10-15x sobre versiÃ³n original**

2. **Single File**: Archivo grande (~3.9k lÃ­neas) dificulta mantenimiento
   - âš ï¸ Ha crecido con optimizaciones
   - Considerar: Separar en mÃ³dulos JS si crece mÃ¡s

3. **Magic Numbers**: Muchos valores hardcoded
   - Mejor: Centralizar mÃ¡s constantes al inicio
   - ğŸ†• Ahora incluye CULLING_DISTANCES centralizadas

4. **No Save System**: Progreso se pierde al recargar
   - Posible mejora: localStorage para guardar

5. **ğŸ†• Pool Capacities**: Pools tienen lÃ­mites fijos
   - Si se exceden: Degrada gracefully creando objetos temporales
   - Actual: Bullet(300), Enemy(150), Particle(600) - suficiente para gameplay normal

## ğŸ¯ Para Claude Code: Estrategia de NavegaciÃ³n

**Cuando el usuario pida:**
- "Modificar daÃ±o" â†’ Leer lÃ­neas 148-222 (constantes) + 1370 (getWeaponStats)
- "AÃ±adir enemigo" â†’ Leer lÃ­neas 1718-1850 (spawnEnemy con pools + updateEnemies con grid)
- "Cambiar UI" â†’ Leer lÃ­neas 1-147 (HTML+CSS) + 2200-2700 (Skill Tree UI)
- "Fix colisiones" â†’ Leer lÃ­neas 2295-2432 (checkCollisions con spatial grid)
- "Sistema de skills" â†’ Leer lÃ­neas 223-390 (SKILL_TREE) + 2200+ (unlockSkill)
- **ğŸ†• "Optimizar performance"** â†’ Leer lÃ­neas 510-780 (sistemas de optimizaciÃ³n)
- **ğŸ†• "Debug/FPS"** â†’ Leer lÃ­neas 695-780 (perfMonitor) + tecla B para toggle overlay
- **ğŸ†• "Memory leaks"** â†’ Revisar lÃ­neas 576-654 (object pools) + buscar `.acquire()` / `.release()`

**Siempre leer primero** este archivo antes de explorar cÃ³digo para contexto rÃ¡pido.

## ğŸ”§ Comandos de Debug

- **Tecla 'B'**: Toggle performance overlay (FPS, entity counts, grid stats)
- **Console**: `perfMonitor` objeto global disponible
- **Console**: `spatialGrid` objeto global disponible
- **Console**: `pools` objeto global disponible

---

## ğŸ”„ Protocolo de ActualizaciÃ³n

**DESPUÃ‰S DE CADA MODIFICACIÃ“N DE CÃ“DIGO:**

1. âœ… Actualizar nÃºmeros de lÃ­nea si se aÃ±adieron/eliminaron lÃ­neas
2. âœ… AÃ±adir nuevas funciones a la secciÃ³n "Funciones CrÃ­ticas"
3. âœ… Actualizar estructuras de datos si cambiaron
4. âœ… Documentar nuevas constantes en la tabla correspondiente
5. âœ… AÃ±adir nuevos sistemas a la secciÃ³n "Mapa de CÃ³digo"
6. âœ… Actualizar la tabla de bÃºsquedas rÃ¡pidas si aplica

**Este archivo es la memoria del proyecto. Sin actualizarlo, Claude perderÃ¡ contexto.**
